<div class="form-card">
    <h3 style="margin-top:0;">Pesan Mekanik</h3>
    <p style="font-size:12px; color:var(--mecha-dim); margin-bottom:20px;">Isi detail kendaraan Anda.</p>
    
    <label>UNIT KENDARAAN</label>
    <select id="vehicleType">
        <option value="Motor Matic">Motor Matic</option>
        <option value="Motor Sport">Motor Sport</option>
        <option value="Mobil">Mobil</option>
    </select>

    <label>JENIS LAYANAN</label>
    <select id="serviceType">
        <option value="Ganti Oli">Ganti Oli</option>
        <option value="Service Rutin">Service Rutin</option>
        <option value="Darurat">Mogok (Emergency)</option>
    </select>

    <label>ALAMAT PENJEMPUTAN</label>
    <textarea id="address" placeholder="Jln. Raya No... (Gg. depan Indomaret)"></textarea>

    <label>CATATAN KELUHAN</label>
    <textarea id="bookingNote" placeholder="Contoh: Mesin berbunyi kasar saat pagi..."></textarea>

    <button class="btn-action" id="btnBooking">
        KONFIRMASI PESANAN
    </button>
</div>

<script type="module">
    // Kita panggil instance yang sudah ada dari Dashboard jika memungkinkan, 
    // atau inisialisasi ulang jika berdiri sendiri.
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const db = getFirestore();
    const auth = getAuth();

    // Event Listener untuk tombol
    document.getElementById('btnBooking').addEventListener('click', async () => {
        const btn = document.getElementById('btnBooking');
        const vehicle = document.getElementById('vehicleType').value;
        const service = document.getElementById('serviceType').value;
        const address = document.getElementById('address').value;
        const note = document.getElementById('bookingNote').value;
        const customerName = document.getElementById('profileNameDisplay')?.innerText || "Anonymous";

        if (!address.trim() || !note.trim()) {
            alert("Harap lengkapi Alamat dan Catatan.");
            return;
        }

        try {
            btn.disabled = true;
            btn.innerText = "MENGIRIM...";

            // Simpan ke Firestore
            await addDoc(collection(db, "bookings"), {
                uid: auth.currentUser.uid,
                customerName: customerName,
                vehicle: vehicle,
                service: service,
                address: address,
                note: note,
                status: "pending",
                createdAt: serverTimestamp()
            });

            alert("Booking Berhasil Terkirim!");
            
            // Reset Form & Pindah Tab
            document.getElementById('address').value = "";
            document.getElementById('bookingNote').value = "";
            
            // Trigger klik navigasi logs di dashboard utama
            document.getElementById('navHistory').click();

        } catch (error) {
            console.error(error);
            alert("Gagal mengirim pesanan.");
        } finally {
            btn.disabled = false;
            btn.innerText = "KONFIRMASI PESANAN";
        }
    });
</script>
