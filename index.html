<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBrluSpKYvgZzz3CjH69SqQp81ydjqI5sI",
        authDomain: "mechajob-v3.firebaseapp.com",
        projectId: "mechajob-v3",
        storageBucket: "mechajob-v3.firebasestorage.app",
        messagingSenderId: "987474678188",
        appId: "1:987474678188:web:950ccca56653af0c51aa09"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI NAVIGATION ---
    window.goToAuth = () => {
        const landing = document.getElementById('landing-section');
        const authSec = document.getElementById('auth-section');
        landing.style.opacity = '0';
        landing.style.transform = 'scale(0.9)';
        setTimeout(() => {
            landing.style.display = 'none';
            authSec.style.display = 'block';
            setTimeout(() => {
                authSec.style.opacity = '1';
                authSec.style.transform = 'translateY(0)';
            }, 50);
        }, 600);
    };

    window.togglePassword = (id, el) => {
        const x = document.getElementById(id);
        if (x.type === "password") {
            x.type = "text";
            el.classList.replace("fa-eye", "fa-eye-slash");
        } else {
            x.type = "password";
            el.classList.replace("fa-eye-slash", "fa-eye");
        }
    };

    window.validateConfirm = () => {
        const p = document.getElementById('reg_password').value;
        const c = document.getElementById('reg_confirm').value;
        const msg = document.getElementById('error_confirm');
        if (c !== "" && p !== c) {
            msg.style.display = "block";
            msg.innerText = "Sandi tidak sama!";
            msg.style.color = "#ff4d4d";
        } else {
            msg.style.display = "none";
        }
    };

    // --- LOGIN LOGIC ---
    window.handleLogin = async () => {
        const email = document.getElementById('login_email').value;
        const password = document.getElementById('login_password').value;
        const btn = document.getElementById('btnAction');

        if(!email || !password) return alert("Isi semua kolom!");
        
        btn.disabled = true;
        btn.innerText = "Memproses...";

        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Redirect manual SETELAH login berhasil
            window.location.href = "pages/dashboard/dashboard.html";
        } catch (e) {
            alert("Login Gagal: Periksa kembali email dan sandi Anda.");
            btn.disabled = false;
            btn.innerText = "Masuk";
        }
    };

    // --- REGISTER LOGIC ---
    window.showRegister = () => {
        document.getElementById('title').innerText = "BUAT AKUN";
        document.getElementById('formContent').innerHTML = `
            <div class="input-box"><input type="text" id="reg_nama" placeholder="Nama Lengkap"></div>
            <div class="input-box"><input type="tel" id="reg_noWa" placeholder="Nomor WhatsApp"></div>
            <div class="input-box"><input type="email" id="reg_email" placeholder="Email"></div>
            <div class="input-box">
                <input type="password" id="reg_password" placeholder="Sandi">
                <i class="fa fa-eye toggle-pass" onclick="togglePassword('reg_password', this)"></i>
            </div>
            <div class="input-box">
                <input type="password" id="reg_confirm" placeholder="Konfirmasi Sandi" oninput="validateConfirm()">
                <i class="fa fa-eye toggle-pass" onclick="togglePassword('reg_confirm', this)"></i>
                <div id="error_confirm" style="display:none; font-size:12px; margin-top:5px;"></div>
            </div>
            <button class="btn-main" id="btnAction" onclick="handleRegister()">Daftar Sekarang</button>
        `;
        document.getElementById('switchBtn').innerHTML = "Sudah punya akun? <b>Login</b>";
        document.getElementById('switchBtn').onclick = () => location.reload();
    };

    window.handleRegister = async () => {
        const nama = document.getElementById('reg_nama').value;
        const noWa = document.getElementById('reg_noWa').value;
        const email = document.getElementById('reg_email').value;
        const password = document.getElementById('reg_password').value;
        const confirm = document.getElementById('reg_confirm').value;
        const btn = document.getElementById('btnAction');

        if(!nama || !noWa || !email || !password || !confirm) return alert("Lengkapi data!");
        if(password !== confirm) return alert("Sandi konfirmasi tidak sama!");

        btn.disabled = true;
        btn.innerText = "Mendaftarkan...";

        try {
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, "users", cred.user.uid), {
                uid: cred.user.uid,
                name: nama,
                noWa: noWa,
                email: email,
                role: "customer",
                createdAt: new Date()
            });
            alert("Registrasi Berhasil!");
            // Redirect manual SETELAH register berhasil
            window.location.href = "pages/dashboard/dashboard.html";
        } catch (e) {
            alert("Gagal: " + e.message);
            btn.disabled = false;
            btn.innerText = "Daftar Sekarang";
        }
    };
</script>
